<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <!-- å“åº”å¼è§†å£ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIç™‚å¿ƒå®¤ ğŸŒ¿</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- è‡ªå®šä¹‰æ ·å¼ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
  <body class="flex flex-col h-screen bg-gray-50">
    <!-- ä¾§è¾¹èœå•ï¼ˆOff-Canvasï¼‰ -->
  <div id="offcanvas" class="hidden fixed inset-0 z-50 flex">
    <!-- åŠé€æ˜é®ç½© -->
    <div
    id="canvas-backdrop"
    class="absolute inset-0 bg-black opacity-50 hidden">
    </div>
    <!-- èœå•å†…å®¹ -->
    <nav id="canvas-menu"
     class="relative bg-white w-64 h-full shadow-xl transform transition-transform -translate-x-full
            overflow-y-auto p-4">
      <div class="p-4 border-b">
        <h2 class="text-lg font-semibold">åŠŸèƒ½é¸å–®</h2>
      </div>
      <ul class="mt-4">
        <li class="p-4 hover:bg-gray-100 cursor-pointer" onclick="clearChat()">æ¸…é™¤èŠå¤©</li>
        <li class="p-4 hover:bg-gray-100 cursor-pointer" onclick="toggleThemePanel()">åˆ‡æ›ä¸»é¡Œ</li>
        <li class="p-4 hover:bg-gray-100 cursor-pointer" onclick="about()">é—œæ–¼</li>
        <!-- æ–°å¢é€™ä¸€è¡Œ -->
        <li class="p-4 hover:bg-gray-100 cursor-pointer" onclick="openCustomRoleForm()">è‡ªå®šç¾©è§’è‰²</li>
        <li class="p-4 hover:bg-gray-100 cursor-pointer" onclick="toggleAgentSelection()">èŠå¤©äººé¸</li>
      </ul>
    

      <!-- è‡ªå®šç¾©è§’è‰²è¨­å®šè¡¨å–® -->
      <div id="customRoleForm" class="p-4 hidden border-t bg-gray-50">
        <h3 class="text-md font-medium mb-2">è‡ªå®šç¾©è§’è‰²è¨­å®š</h3>

        <!-- åå­— -->
        <label for="cr-name" class="block mb-1">åå­—ï¼š</label>
        <input id="cr-name" name="cr-name" type="text"
              class="w-full mb-2 px-2 py-1 border rounded"
              placeholder="ä¾‹å¦‚ï¼šå°å®‡">

        <!-- è·æ¥­ -->
        <label for="cr-profession" class="block mb-1">è·æ¥­ï¼š</label>
        <input id="cr-profession" name="cr-profession" type="text"
              class="w-full mb-2 px-2 py-1 border rounded"
              placeholder="ä¾‹å¦‚ï¼šéœ¸æ°£åæ§½ç‹">

        <!-- äººæ ¼æè¿° -->
        <label for="cr-description" class="block mb-1">äººæ ¼æè¿°ï¼š</label>
        <textarea id="cr-description" name="cr-description" rows="2"
                  class="w-full mb-2 px-2 py-1 border rounded"
                  placeholder="ä¾‹å¦‚ï¼šç›´ä¾†ç›´å¾€ã€åæ§½åŠ›æ»¿é»"></textarea>

        <!-- èªè­˜å¹´æ•¸ -->
        <label for="cr-years" class="block mb-1">èªè­˜å¹´æ•¸ï¼š</label>
        <input id="cr-years" name="cr-years" type="number" min="0"
              class="w-full mb-2 px-2 py-1 border rounded"
              placeholder="ä¾‹å¦‚ï¼š10">

        <!-- å¸¸å¸¸èˆ‡ä½  -->
        <label for="cr-relation" class="block mb-1">å¸¸å¸¸èˆ‡ä½ ï¼š</label>
        <select id="cr-relation" name="cr-relation"
                class="w-full mb-2 px-2 py-1 border rounded">
          <option value="å”±åèª¿">å”±åèª¿</option>
          <option value="ç«™ä¸€é‚Š">ç«™ä¸€é‚Š</option>
        </select>

        <!-- èªæ°£ -->
        <label for="cr-tone" class="block mb-1">èªæ°£ï¼š</label>
        <input id="cr-tone" name="cr-tone" type="text"
              class="w-full mb-2 px-2 py-1 border rounded"
              placeholder="ä¾‹å¦‚ï¼šç›´ç™½å¹½é»˜">

        <!-- åœ–ç¤ºé¸æ“‡ï¼ˆåµŒå¥—å¼ï¼Œä¸éœ€è¦ for/idï¼‰ -->
        <label class="block mb-1">é¸æ“‡è§’è‰²åœ–ç¤ºï¼š</label>
        <div
             id="cr-icon-options"
             class="flex space-x-3 mb-4 overflow-x-auto"
             style="scrollbar-width: thin; /* Firefox */"
          >  
          <label class="option cursor-pointer text-2xl inline-flex items-center">
            <input type="radio" name="cr-icon" value="ğŸ™‹â€â™‚ï¸" checked class="hidden">
            <span aria-hidden="true">ğŸ™‹â€â™‚ï¸</span>
          </label>
          <label class="option cursor-pointer text-2xl inline-flex items-center">
            <input type="radio" name="cr-icon" value="ğŸ§‘â€ğŸ¦°" class="hidden">
            <span aria-hidden="true">ğŸ§‘â€ğŸ¦°</span>
          </label>
          <label class="option cursor-pointer text-2xl inline-flex items-center">
            <input type="radio" name="cr-icon" value="ğŸ‘¼" class="hidden">
            <span aria-hidden="true">ğŸ‘¼</span>
          </label>
          <label class="option cursor-pointer text-2xl inline-flex items-center">
            <input type="radio" name="cr-icon" value="ğŸ·" class="hidden">
            <span aria-hidden="true">ğŸ·</span>
          </label>
          <label class="option cursor-pointer text-2xl inline-flex items-center">
            <input type="radio" name="cr-icon" value="ğŸ‘©" class="hidden">
            <span aria-hidden="true">ğŸ‘©</span>
          </label>
        </div>

        <div class="mt-3 flex justify-end space-x-2">
          <button onclick="closeCustomRoleForm()"
                  class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
            å–æ¶ˆ
          </button>
          <button onclick="saveCustomRole()"
                  class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
            å„²å­˜
          </button>
        </div>
      </div>
      
      <!-- ä¸»é¢˜é€‰æ‹©æŠ˜å é¢æ¿ -->
      <div id="themePanel" class="p-4 hidden border-t bg-gray-50">
        <h3 class="text-md font-semibold mb-2">ä¸»é¡Œé…è‰²</h3>
        <div class="flex space-x-4">
          <!-- æ¯ä¸ª swatch ç”¨ data-theme-key æ ‡è®° -->
               <!-- æ–°å¢ï¼šåŸå§‹é è¨­ -->
          <div class="swatch cursor-pointer" data-theme-key="default" title="é è¨­é¢¨æ ¼"></div>
          <div class="swatch cursor-pointer" data-theme-key="sunrise" title="é™½å…‰é‡‘"></div>
          <div class="swatch cursor-pointer" data-theme-key="mint"    title="è–„è·ç¶ "></div>
          <div class="swatch cursor-pointer" data-theme-key="mocha"   title="æ‘©å¡æ£•"></div>
          <div class="swatch cursor-pointer" data-theme-key="night"   title="å¤œå¹•é»‘"></div>
        </div>
      </div>
       <!-- èŠå¤©äººé¸ -->
      <div id="agentSelectionPanel" class="p-4 hidden border-t bg-gray-50">
          <h3 class="text-md font-semibold mb-2">èŠå¤©äººé¸ (æœ€å¤š 3 ä½)</h3>
          <div id="agentCheckboxes" class="space-y-2">
            <!-- JS ä¼šåœ¨è¿™é‡Œæ’å…¥å°å®‡/å®‰å®‰/çš®çš® ä»¥åŠè‡ªå®šä¹‰è§’è‰²çš„å¤é€‰æ¡† -->
          </div>
      </div>

    </nav>
  </div>


  <!-- é ‚éƒ¨æ¨™é¡Œ -->
  <header class="relative bg-[var(--primary-bg)] text-white text-center py-4 shadow-md flex items-center justify-center">
    <!-- æ±‰å ¡æŒ‰é’® -->
    <button id="menuBtn" class="absolute left-4 text-white focus:outline-none">
      <!-- Heroicons Menu SVG -->
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
           viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
  
    <!-- å±…ä¸­æ ‡é¢˜ -->
    <div class="mx-auto">
      <h1 class="text-2xl font-bold">ğŸŒŸ AIç™‚å¿ƒå®¤ ğŸŒŸ</h1>
      <p class="text-sm mt-1 italic">ç™‚å¿ƒå®¤ï¼Œè®“ä½ æ”¾å¿ƒèŠå¿ƒäº‹</p>
    </div>
  </header>
  

  <!-- èŠå¤©å…§å®¹ -->
  <main id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-2 bg-white">
    <!-- è¨Šæ¯æœƒåŠ åœ¨é€™è£¡ -->
  </main>

  <!-- è¼¸å…¥å€ -->
  <footer>
    <div id="inputArea" class="flex items-center p-4 space-x-3 bg-white shadow-inner">
      <input
        id="userInput"
        class="flex-1 px-4 py-2 h-12 border rounded-full focus:outline-none focus:ring focus:ring-blue-200"
        placeholder="è«‹è¼¸å…¥è¨Šæ¯..."
        autocomplete="off"
      />
      <button
        id="sendBtn"
        class="h-12 px-4 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition"
      >
        é€å‡º
      </button>
    </div>
  </footer>

  <!-- JS å€ -->
  <script>
    // åªåœ¨æœ€å¼€å¤´å£°æ˜ä¸€æ¬¡ï¼š
    const maxAgents = 3;
    let selectedAgents = ['å°å®‡','å®‰å®‰','çš®çš®'];
    const allAgents = ['å°å®‡','å®‰å®‰','çš®çš®'];
    const customPrompts = {};  // name -> system_prompt
    // åˆå§‹ä¸‰ä½éƒ½é€‰ä¸­
    // é¡µé¢åŠ è½½åï¼Œå…ˆæ¸²æŸ“ä¸€æ¬¡å¤é€‰æ¡†
    renderAgentCheckboxes();
    // â€”â€” æ–°å¢æŠ˜å å‡½æ•° â€”â€” //
    function toggleAgentSelection() {
      document
        .getElementById("agentSelectionPanel")
        .classList
        .toggle("hidden");
    }

    // å­˜æ”¾è‡ªå®šä¹‰è§’è‰²çš„ Icon
    const customIcons   = {};

    /** é–‹å•Ÿè‡ªå®šç¾©è§’è‰²è¡¨å–® **/
    function openCustomRoleForm() {
      document.getElementById("customRoleForm").classList.remove("hidden");
    }

    /** é—œé–‰è‡ªå®šç¾©è§’è‰²è¡¨å–® **/
    function closeCustomRoleForm() {
      document.getElementById("customRoleForm").classList.add("hidden");
    }


    // æ¸²æŸ“å¤é€‰æ¡†åˆ—è¡¨
    function renderAgentCheckboxes() {
      const container = document.getElementById("agentCheckboxes");
      container.innerHTML = "";

      allAgents.forEach(name => {
        const label = document.createElement("label");
        label.className = "flex items-center space-x-2";

        const cb = document.createElement("input");
        cb.type      = "checkbox";
        cb.className = "agent-checkbox";
        cb.value     = name;
        // åªæœ‰åœ¨ selectedAgents é‡Œæ‰å‹¾é€‰
        cb.checked   = selectedAgents.includes(name);

        const span = document.createElement("span");
        span.textContent = name;

        label.append(cb, span);
        container.append(label);
      });

      bindAgentCheckboxes();  // ç»§ç»­ä½¿ç”¨å·²æœ‰çš„ç»‘å®šé€»è¾‘
    }


    // åœ¨è„šæœ¬æœ€åï¼Œç¡®ä¿ä¸€åŠ è½½å°±æ¸²æŸ“åˆå§‹åˆ—è¡¨
    renderAgentCheckboxes();

    const ICONS = {
      user:   "ğŸ‘¤",
      å°å®‡:   "ğŸ™â€â™‚ï¸",
      å®‰å®‰:   "ğŸ§–â€â™€ï¸",
      çš®çš®:   "ğŸ¤¹â€â™‚ï¸",
      ç³»çµ±:   "âš™ï¸"
    };

    const input   = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatBox = document.getElementById("chatBox");
    

    function getAgentCheckboxes() {
      return Array.from(document.querySelectorAll('.agent-checkbox'));
    }


    function updateAgentCheckboxes() {
      const checked = Array.from(agentCheckboxes).filter(c => c.checked);
      // ç¦ç”¨å…¶ä½™ checkbox
      getAgentCheckboxes().forEach(c => {
        if (!c.checked) {
          c.disabled = (checked.length >= maxAgents);
        }
      });
    }
    // åˆå§‹åŒ–
    updateAgentCheckboxes();
    // ç»‘å®š change äº‹ä»¶
    getAgentCheckboxes().forEach(c => {
      c.addEventListener('change', updateAgentCheckboxes);
    });

    // åœ¨å‘é€æ—¶ï¼Œæ”¶é›†é€‰ä¸­çš„è§’è‰²
    function getSelectedAgents() {
      return Array.from(
        document.querySelectorAll('.agent-checkbox')
      )
      .filter(cb => cb.checked)
      .map(cb => cb.value);
    }

    async function sendMessage() {
      const msg = input.value.trim();
      if (!msg) return;

      const agents = getSelectedAgents();
      if (agents.length === 0) {
        alert('è‡³å°‘é¸ä¸€ä½èŠå¤©äººé¸');
        return;
      }

      // å…ˆæ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯
      appendMsg("ä½ ", msg, "user");
      input.value = "";

      // æŠŠå‚ä¸è€…åå•ä¹Ÿå¡è¿›å»
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: msg,
          participants: agents,
          custom: customPrompts
        })
      });

      const data = await res.json();
      if (data.error) {
        appendMsg("ç³»çµ±", data.error, "ç³»çµ±");
        return;
      }

      data.responses.forEach((r, idx) => {
        setTimeout(() => {
          appendMsg(r.name, r.content, r.name);
        }, idx * 800);
      });
    }

    function appendMsg(name, content, cls) {
      const div = document.createElement("div");
      div.className = `msg ${cls}`;

      // ä¼˜å…ˆï¼šç”¨æˆ·è‡ªå®šä¹‰ icon > é¢„è®¾ ICONS > é»˜è®¤äººå½¢
      const icon = customIcons[cls] ?? ICONS[cls] ?? "ğŸ‘¤";

      div.innerHTML = `
        <span class="icon">${icon}</span>
        <div class="text">
          <strong>${name}</strong><br>
          ${content}
        </div>
      `;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }


    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keypress", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });

    // â€”â€” ä»¥ä¸‹æ˜¯æ¼¢å ¡èœå–®é‚è¼¯ï¼Œä¸ä¿®æ”¹ä¸Šé¢ä»»ä½•åŠŸèƒ½ â€”â€” //

    // å–å…ƒç´ 
    const offcanvas  = document.getElementById("offcanvas");
    const menuPanel  = document.getElementById("canvas-menu");
    const backdrop   = document.getElementById("canvas-backdrop");
    const menuBtn    = document.getElementById("menuBtn");

    function toggleMenu() {
      const isHidden = offcanvas.classList.contains("hidden");
      if (isHidden) {
        offcanvas.classList.remove("hidden");
        requestAnimationFrame(() => {
          menuPanel.classList.replace("-translate-x-full", "translate-x-0");
        });
      } else {
        menuPanel.classList.replace("translate-x-0", "-translate-x-full");
        menuPanel.addEventListener("transitionend", () => {
          offcanvas.classList.add("hidden");
        }, { once: true });
      }
    }

    // ç‚¹å‡»æŒ‰é’®æˆ–é®ç½©éƒ½åˆ‡æ¢èœå•
    menuBtn.addEventListener("click", toggleMenu);
    backdrop.addEventListener("click", toggleMenu);
    // èœå–®é …ç›®åŠŸèƒ½ç¯„ä¾‹
    function clearChat() {
      chatBox.innerHTML = "";
      toggleMenu();
    }
    function toggleTheme() {
      document.body.classList.toggle("dark");
      toggleMenu();
    }
    function about() {
      alert("AIç™‚å¿ƒå®¤ v1.0\nÂ© 2025ï¼ŒJiayou Lin");
      toggleMenu();
    }

      // â€”â€” æ–°å¢ï¼šç‚¹å‡»ç©ºç™½è‡ªåŠ¨å…³èœå• â€”â€” //
    document.addEventListener('click', function(e) {
      // å¦‚æœèœå•å½“å‰æ˜¯æ‰“å¼€çŠ¶æ€
      const isOpen = !offcanvas.classList.contains('hidden');
      if (!isOpen) return;

      // ç‚¹å‡»ç›®æ ‡ï¼šæ—¢ä¸åœ¨èœå•é¢æ¿å†…ï¼Œä¹Ÿä¸æ˜¯èœå•æŒ‰é’®
      const clickedInsideMenu = menuPanel.contains(e.target);
      const clickedMenuBtn    = menuBtn.contains(e.target);

      if (!clickedInsideMenu && !clickedMenuBtn) {
        toggleMenu();
      }
    });

    // é¢„è®¾ä¸»é¢˜è‰²æ¿
    const themes = {
      default: {
        primaryBg:  '#f5f7fa',  // åŸå§‹ ç±³ç™½
        accent:     '#1cbbb4',  // åŸå§‹ è—è‰²
        bubbleUser: '#9ee5e1'   // åŸå§‹ ç”¨æˆ¶æ°£æ³¡
      },
      sunrise: {
        primaryBg:  '#F5C469',
        accent:     '#f37b1d',
        bubbleUser: '#F9E7BE'
      },
      mint: {
        primaryBg:  '#E0F7F1',
        accent:     '#4ABDAC',
        bubbleUser: '#D1F0E8'
      },
      mocha: {
        primaryBg:  '#F1EDEA',
        accent:     '#79a6ea',
        bubbleUser: '#E8DFD7'
      },
      night: {
        primaryBg:  '#2E2E2E',
        accent:     '#6739b6',
        bubbleUser: '#cdb8f3'
      }
    };

    const themePanel = document.getElementById("themePanel");

    // åˆ‡æ¢ä¸»é¢˜é¢æ¿æ˜¾ç¤º/éšè—
    function toggleThemePanel() {
      themePanel.classList.toggle("hidden");
    }

    // åº”ç”¨æŸä¸ªä¸»é¢˜
    function applyTheme(key) {
      const t = themes[key];
      if (!t) return;
      const root = document.documentElement;
      root.style.setProperty('--primary-bg',  t.primaryBg);
      root.style.setProperty('--accent',      t.accent);
      root.style.setProperty('--bubble-user', t.bubbleUser);

      // æ›´æ–°é€‰ä¸­æ€
      document.querySelectorAll('#cr-icon-options .swatch')
        .forEach(el => el.classList.remove('selected'));
      document.querySelector(`.swatch[data-theme-key="${key}"]`)
        .classList.add('selected');
    }

    // åˆå§‹åŒ–ï¼šä¸ºæ¯ä¸ª swatch ç»‘å®šç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.swatch').forEach(el => {
      el.addEventListener('click', () => {
        applyTheme(el.dataset.themeKey);
      });
    });

    // ä½ ä¹Ÿå¯ä»¥åœ¨é¡µé¢åŠ è½½æ—¶è®¾é»˜è®¤ä¸»é¢˜
    applyTheme('sunrise');


        /** æ‰“å¼€è‡ªå®šä¹‰è§’è‰²è¡¨å• **/
    function openCustomRoleForm() {
      document.getElementById("customRoleForm").classList.remove("hidden");
    }
    



    function saveCustomRole() {
      // 1. è¯»å–å¹¶æ ¡éªŒæ‰€æœ‰å­—æ®µ
      const name       = document.getElementById("cr-name").value.trim();
      const profession = document.getElementById("cr-profession").value.trim();
      const desc       = document.getElementById("cr-description").value.trim();
      const years      = document.getElementById("cr-years").value.trim();
      const relation   = document.getElementById("cr-relation").value;
      const tone       = document.getElementById("cr-tone").value.trim();
      const iconVal    = document.querySelector('input[name="cr-icon"]:checked').value;

      if (!name || !profession || !desc || !years || !relation || !tone) {
        alert("è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼");
        return;
      }

      // 2. æ‹¼å‡ºè§’è‰²çš„ System Prompt
      const roleTemplate = `("${name}", """
    # Role: ${profession} ğŸ™â€â™‚ï¸
    -language: ç¹é«”ä¸­æ–‡
    -description: ${desc}
    ## Attention
    ä½ æ˜¯ä¸€å€‹${profession}ï¼Œèˆ‡useræ“æœ‰${years}å¹´å‹èª¼ã€‚
    ä½ çš„ä»»å‹™æ˜¯ï¼š
    + èˆ‡user${relation}ã€‚
    + èˆ‡userèŠå¤©ï¼Œåƒæ˜¯æœ‹å‹ä¸€æ¨£ã€‚
    + èƒ½å¤ ä¸€èµ·ç©æ¨‚ï¼Œä¹Ÿå¯ä»¥å…±åŒèµ°éå›°å¢ƒã€‚     
    ## Constraints
    - èªæ°£${tone}ã€‚
    - ä¸è¦å¤ªæ­»æ¿ï¼Œæœ‰æƒ…æ„Ÿçš„èŠå¤©ã€‚
    """)`;

      // 3. å­˜åˆ° customPrompts å’Œ customIcons
      customPrompts[name] = roleTemplate;
      customIcons[name]   = iconVal;

      // 4. æ›´æ–° allAgents æ•°ç»„å¹¶é‡ç»˜å¤é€‰æ¡†åˆ—è¡¨
      allAgents.push(name);
      // 2) å¦‚æœå½“å‰å·²é€‰ < 3ï¼Œå°±æŠŠå®ƒé»˜è®¤é€‰ä¸­
      if (selectedAgents.length < maxAgents) {
        selectedAgents.push(name);
      } else {
        // å¦åˆ™ä¸é»˜è®¤é€‰ï¼Œè®©ç”¨æˆ·è‡ªå·±å»å‹¾
        // alert("å½“å‰å·²é€‰è¾¾åˆ°ä¸Šé™ï¼Œæ–°è§’è‰²æœªè‡ªåŠ¨å‹¾é€‰");
      }

      // 3) é‡æ–°æ¸²æŸ“
      renderAgentCheckboxes();

      // 5. æ¸…ç©ºè¡¨å•å­—æ®µï¼ˆæ‰‹åŠ¨èµ‹ç©ºï¼‰
      document.getElementById("cr-name").value        = "";
      document.getElementById("cr-profession").value  = "";
      document.getElementById("cr-description").value = "";
      document.getElementById("cr-years").value       = "";
      document.getElementById("cr-relation").value    = "å”±åèª¿";
      document.getElementById("cr-tone").value        = "";
      // é‡ç½® Icon å•é€‰å›ç¬¬ä¸€ä¸ª
      document.querySelector('input[name="cr-icon"][value="ğŸ™‹â€â™‚ï¸"]').checked = true;

      // 6. ç»™ç”¨æˆ·æç¤ºå¹¶å…³é—­è¡¨å•
      appendMsg("ç³»çµ±", `å·²æ–°å¢è§’è‰²ï¼š${name}`, "ç³»çµ±");
      closeCustomRoleForm();
    }





    /**
     * ç»‘å®šæ‰€æœ‰ .agent-checkbox çš„ change äº‹ä»¶
     * å¹¶ç«‹å³æ›´æ–°ç¦ç”¨çŠ¶æ€ï¼ˆæœ€å¤š 3 ä½ï¼‰
     */
    function bindAgentCheckboxes() {
      const boxes = document.querySelectorAll(".agent-checkbox");
      boxes.forEach(cb => {
        // å…ˆç§»é™¤å¯èƒ½å·²å­˜åœ¨çš„é‡å¤ç›‘å¬
        cb.replaceWith(cb.cloneNode(true));
      });
      const fresh = document.querySelectorAll(".agent-checkbox");
      fresh.forEach(cb => {
        cb.addEventListener("change", updateAgentCheckboxes);
      });
      // ä¸€æ¬¡æ€§æ‰§è¡Œä¸€æ¬¡æ›´æ–°ï¼Œè®©è¶…è¿‡é™åˆ¶çš„ç¦ç”¨æ‰
      updateAgentCheckboxes();
    }

    /**
     * æ ¹æ®å·²é€‰æ•°é‡ï¼Œç¦ç”¨å…¶ä½™å¤šä½™å¤é€‰æ¡†
     */
    function updateAgentCheckboxes() {
      const boxes   = Array.from(document.querySelectorAll(".agent-checkbox"));
      const checked = boxes.filter(c => c.checked).length;
      boxes.forEach(cb => {
        if (!cb.checked) {
          cb.disabled = (checked >= 3);
        }
      });
    }

    // é¡µé¢åŠ è½½æ—¶ï¼Œå…ˆå¯¹åŸç”Ÿ 3 ä½åšä¸€æ¬¡ç»‘å®š
    bindAgentCheckboxes();
    // åœ¨è„šæœ¬æœ«å°¾ï¼ŒæŠŠåŸå§‹é£æ ¼ä½œä¸ºç¬¬ä¸€é€‰æ‹©
    applyTheme('default');

    </script>


</body>
</html>
